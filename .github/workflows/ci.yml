name: ci
on:
  pull_request: { branches: [ main ] }
  push: { branches: [ main ] }
jobs:
  repo-hygiene:
    name: Repository Hygiene Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史以检查所有文件
      - name: Check for forbidden files
        run: bash .github/scripts/check-repo-hygiene.sh
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: repo-hygiene  # 卫生检查通过后才执行lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '22' }
      - name: Install dependencies (backend)
        run: cd backend && npm ci
      - name: Run lint (backend)
        run: cd backend && npm run lint
  
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: repo-hygiene
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '22' }
      - name: Install dependencies (backend)
        run: cd backend && npm ci
      - name: Run tests (backend)
        run: cd backend && npm run test -- --coverage
  
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: repo-hygiene
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '22' }
      - name: Install dependencies (backend)
        run: cd backend && npm ci
      - name: Build (backend)
        run: cd backend && npm run build
